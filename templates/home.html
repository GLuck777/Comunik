<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Accueil</title>
  <link rel="icon" type="image/x-icon" href="/static/ressources/logoU.png">
  <link rel="stylesheet" type="text/css" href="/static/css/style_for_all.css">
  <link rel="stylesheet" type="text/css" href="/static/css/home.css">
  <link rel="stylesheet" type="text/css" href="/static/css/header.css">
  <link rel="stylesheet" type="text/css" href="/static/css/messages.css">
  <link rel="stylesheet" type="text/css" href="/static/css/bg_canvas.css"> 
</head>
<body class="bg-line">
  <canvas id="matrixCanvas"></canvas>
  <header>
    <a href="/home" class="logo"><img src="/static/ressources/logoU.png" alt="logoU"></a>
    <div class="header-actions">
      <div class="flex items-center space-x-2"><div class="h-2 w-2 bg-green-400 rounded-full"></div><span>Online</span></div>
      <button class="redir" id="profil_show">
        <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
          <path fill="currentColor" d="M12 12.25c1.24 0 2.25-1.01 2.25-2.25S13.24 7.75 12 7.75S9.75 8.76 9.75 10s1.01 2.25 2.25 2.25m4.5 4c0-1.5-3-2.25-4.5-2.25s-4.5.75-4.5 2.25V17h9zM19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 16H5V5h14z"/>
        </svg>
      </button>
      <form method="POST" action="/logout">
        <button type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24">
            <path fill="currentColor" d="M6 2h9a2 2 0 0 1 2 2v2h-2V4H6v16h9v-2h2v2a2 2 0 0 1-2 2H6a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2"/>
            <path fill="currentColor" d="M16.09 15.59L17.5 17l5-5l-5-5l-1.41 1.41L18.67 11H9v2h9.67z"/>
          </svg>
        </button>
      </form>
    </div>
  </header>
  <!-- Notification -->
  <div class="notification-wrapper">
    <div class="burger" onclick="toggleNotifications()">
      <!-- Icône burger SVG -->
      <svg width="30" height="30" viewBox="0 0 100 80" fill="white">
        <rect width="100" height="15"></rect>
        <rect y="30" width="100" height="15"></rect>
        <rect y="60" width="100" height="15"></rect>
      </svg>
    </div>
  
    <div class="notifications" id="notifications">
      <h4>Notifications</h4>
      <ul id="notifications-list">

      </ul>
    </div>
  </div>
  <!-- Fin Notification -->
   <!-- Cellule de présentation -->
  <div class="corpus_holmes identity">
    <div class="form_room">
      <p>Connecté en tant que : <strong>{{ username }}</strong> ({{ email }})  {{ uuid }}</p>
      <input type="hidden" id="uuid" value="{{ uuid }}">
      <!-- Bouton pour ouvrir le modal -->
      <button id="open_room_modal" class="open_room_modal">Créer une Room</button>
      <!-- Modal -->
      <div id="room-modal">
        <div class="modal_add_room">
          <h3>Créer une Room</h3>
          <form id="create_room_form">
            <div class="form">
              <div class="inputBox">
                <input type="text" name="room_name" placeholder=" " required>
                <i>Nom de la Room</i>
              </div>
              <div class="inputBox">
                <select name="visibility">
                  <option value="private">Privée</option>
                  <option value="public">Publique</option>
                </select>
                <label>Visibilité</label>
              </div>
              <div class="inputBox">
                <input type="text" id="invitees_input" name="invitees" placeholder=" " autocomplete="off">
                <i>Inviter des amis</i>
                <div id="invitees-hint">Tapez un pseudo ou UUID, cliquez pour ajouter</div>
                <ul id="invitees_suggestions"></ul>
              </div>
            </div>
            <button type="submit">Créer</button>
            <button type="button" id="close-room-modal">Annuler</button>
          </form>
        </div>
      </div>
      <!-- fin modale-->
    </div>
  </div>
  <!-- Fin de cellule de présentation -->
  <!-- Cellule principale -->
  <div class="corpus_holmes">
    <!-- Onglet pour changer de secteur -->
    <div class="tabs">
      <button id="btn_room" class="active-tab" onclick="showTab('room_tab')">Rooms</button>
      <button id="btn_search" onclick="showTab('search_tab')">Recherche</button>
    </div>
    <!-- Onglet de recherche -->
    <div id="search_tab" style="display: none;">
      <div class="search_users">
        <!-- Zone de recherche -->
        <div class="left_search">
          <h3>Recherche de membres</h3>
          <div class="flex items-center">
            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" 
              class="">
              <circle cx="11" cy="11" r="8"></circle>
              <path d="m21 21-4.3-4.3"></path>
            </svg>
            <input type="text" placeholder="Search users..." 
            class="search_bar" value="">
            
          </div>
          <datalist id="user_list"></datalist>
          <div id="list_user" class=""></div>
        </div> <!-- fin zone de recherche-->
        <!-- Zone de liste amis -->
        <div class="right_search">
          <h3>Liste des membres affiliés</h3>
          <div id="list_demand" class=""></div>

        </div>
      </div>
    </div>

    <!-- Onglet room -->
    <div id="room_tab">
      <div class="disp_flex">
        <div class="aff_room">
          <h2 class="decal_title">Room: <p id="room_name"></p></h2>
          <div id="messages_post"> <!-- Contenant pour afficher les messages -->
            <!-- <div class="room_closed" id="sas_door"></div> -->
            <div class="door_wrapper" id="sas_door">
              <div class="door door_left"></div>
              <div class="door door_right"></div>
            </div>
            <div class="settings">
              <button id="" onclick="settings()"> <!-- Ouvre une fenetre modale qui permet de modifier le parametre de la room, ajout de collegue, changement du nom, suppression de la room-->
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24">
                  <mask id="lineMdCogFilled0">
                    <defs>
                      <symbol id="lineMdCogFilled1">
                        <path d="M11 13L15.74 5.5C16.03 5.67 16.31 5.85 16.57 6.05C16.57 6.05 16.57 6.05 16.57 6.05C16.64 6.1 16.71 6.16 16.77 6.22C18.14 7.34 19.09 8.94 19.4 10.75C19.41 10.84 19.42 10.92 19.43 11C19.43 11 19.43 11 19.43 11C19.48 11.33 19.5 11.66 19.5 12z">
                          <animate fill="freeze" attributeName="d" begin="0.5s" dur="0.2s" values="M11 13L15.74 5.5C16.03 5.67 16.31 5.85 16.57 6.05C16.57 6.05 16.57 6.05 16.57 6.05C16.64 6.1 16.71 6.16 16.77 6.22C18.14 7.34 19.09 8.94 19.4 10.75C19.41 10.84 19.42 10.92 19.43 11C19.43 11 19.43 11 19.43 11C19.48 11.33 19.5 11.66 19.5 12z;M11 13L15.74 5.5C16.03 5.67 16.31 5.85 16.57 6.05C16.57 6.05 19.09 5.04 19.09 5.04C19.25 4.98 19.52 5.01 19.6 5.17C19.6 5.17 21.67 8.75 21.67 8.75C21.77 8.92 21.73 9.2 21.6 9.32C21.6 9.32 19.43 11 19.43 11C19.48 11.33 19.5 11.66 19.5 12z"/>
                        </path>
                      </symbol>
                    </defs>
                    <g fill="none" stroke="#fff" stroke-width="2">
                      <path stroke-dasharray="36" stroke-dashoffset="36" stroke-width="5" d="M12 7c2.76 0 5 2.24 5 5c0 2.76 -2.24 5 -5 5c-2.76 0 -5 -2.24 -5 -5c0 -2.76 2.24 -5 5 -5Z">
                        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.5s" values="36;0"/>
                        <set fill="freeze" attributeName="opacity" begin="0.5s" to="0"/>
                      </path>
                      <g fill="#fff" stroke="none" opacity="0">
                        <use href="#lineMdCogFilled1"/>
                        <use href="#lineMdCogFilled1" transform="rotate(60 12 12)"/>
                        <use href="#lineMdCogFilled1" transform="rotate(120 12 12)"/>
                        <use href="#lineMdCogFilled1" transform="rotate(180 12 12)"/>
                        <use href="#lineMdCogFilled1" transform="rotate(240 12 12)"/>
                        <use href="#lineMdCogFilled1" transform="rotate(300 12 12)"/>
                        <set fill="freeze" attributeName="opacity" begin="0.5s" to="1"/>
                      </g>
                    </g>
                    <circle cx="12" cy="12" r="3.5"/>
                  </mask><rect width="24" height="24" fill="currentColor" mask="url(#lineMdCogFilled0)"/>
                </svg>
              </button>
            </div>
            <!-- MODAL POUR MODIFICATION D'UNE ROOM (en travaux) -->
            <div id="roomModal" class="modal">
              <div class="modal_content">
                <span class="close-btn" onclick="closeRoomModal()">&times;</span>
                <h2>Paramètres de la Room</h2>
                
                <div class="modal-section">
                  <label for="roomName">Nom de la room :</label>
                  <div class="choice_set">
                    <input type="text" name="change_Rname" id="change_Rname" value="">
                    <button onclick="editRoomName()" style="background-color: rgb(58, 92, 24); color: #dedede;">Changer</button>
                  </div>
                </div>
            
                <div class="modal-section">
                  <label>Collègues :</label>
                  <ul id="roomColleagues">
                    
                  </ul>
                  <label for="addColleagues">Ajouter un/des collegue(s)</label>
                  <div class="choice_set">
                    <input type="text" id="new_inv" name="new_inv" placeholder="Rechercher un pseudo..." list="user_list">
                    <datalist id="user_list"></datalist>
                    <button onclick="addMembers()" style="background-color: rgb(58, 92, 24); color: #dedede;">Ajouter</button>
                    <ul id="new_inv_suggestions" class="suggestions-box"></ul>
                  </div>
                </div>
            
                <div class="modal-section danger-zone">
                  <button onclick="deleteRoom()">🗑 Supprimer la room</button>
                </div>
              </div>
            </div>
            <div class="message_content" id="message_content"></div>
            <div class="message_Sender">
              <input type="text" id="message_input" placeholder="Tapez votre message...">
              <button id="sender_btn" class="sender_btn" onclick="sendMessage()">Envoyer</button>
            </div>
          </div>
        </div>
        <!-- a finir en ajoutant le nom de tous les membres disponibles-->
         <!-- En travaux : ajouter systeme de recherche -->
        <aside class="list_room">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" id="rotate_icon" class="svg_retry">
            <path fill="currentColor" d="M12 5V1L7 6l5 5V7c3.31 0 6 2.69 6 6s-2.69 6-6 6s-6-2.69-6-6H4c0 4.42 3.58 8 8 8s8-3.58 8-8s-3.58-8-8-8"/>
          </svg>
          <h2>Rooms disponibles :</h2>
          {% if rooms and rooms | length > 0 %}
              <div class="rooms_container" id="rooms_container">
                  {% for room in rooms %}
                      <div class="room_card" onclick="openRoom('{{ room.room_uuid }}')">
                              <h3>{{ room.name }}</h3>
                              <p><strong>Membres :</strong> {{ room.member_count }}</p>
                      </div>
                  {% endfor %}
              </div>
          {% else %}
            <div class="rooms_container" id="rooms_container">
              <p style="color: white;">Aucune room disponible.</p>
            </div>
          {% endif %}
        </aside>
      </div> <!-- fin disp_flex-->
    </div>

  </div><!-- fin de corpus_holmes-->
</body>
</html>
<script src="/static/js/hack_er.js"></script>

<script>
  // === WebSocket ===
  let socket = null;
  let currentRoomUuid = null;
  let current_user_uuid = document.getElementById("uuid").value;
  let liste_utilisateurs = []; // {pseudo: "Nom", uuid: "uuid"}
  let selected_users = new Map(); // pseudo -> uuid
  let glob_room_name = null;

  
  // To manage each connection to the WebSocket
  async function connectToWebSocket(path = "/ws/") {
    const fullUrl = `ws://${window.location.host}${path}`;
    console.log("Connecting to WebSocket at:", fullUrl);
    
    // Close existing connection if open
    if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
      socket.close();
    }
    
    // Create new WebSocket connection
    socket = new WebSocket(fullUrl);
    socketReady = false;
    
    socket.onopen = () => {
      console.log("Socket connected to", fullUrl);
      socketReady = true;
    };
    
    socket.onerror = (e) => {
      console.error("WebSocket error:", e);
      socketReady = false;
    };
    
    socket.onclose = (event) => {
      console.log("Socket closed:", event);
      socketReady = false;
      if (event.code) console.log("Code:", event.code);
      if (event.reason) console.log("Reason:", event.reason);
      
      // Optional: Implement reconnection after delay
      if (event.code === 1006) {
        console.log("Unexpected disconnect. Trying to reconnect in 5 seconds...");
        // setTimeout(() => {
          // console.clear();
          // connectTo_WebSocket(path);
        // }, 5000);
      }
    };
    
    socket.onmessage = (event) => {
      // console.log("🎯 WebSocket message received:", event.data);
      handleIncomingMessage(event.data);
    };
    
    return socket;
  }

  // En selectionnant une room on recupère les informations liées à la room 
  async function openRoom(roomUuid) {
    if (!roomUuid) {
      console.error("Room UUID is undefined or empty");
      return;
    }
    // const door = document.getElementById("sas_door");
    // if (door){
    //   door.classList.add("opening");
      
    //   // Optionnel : supprimer la div après l'animation
    //   door.addEventListener("animationend", () => {
    //     door.style.display = "none";
    //   });
    // }
    
    console.log("Opening room:", roomUuid);
    await connectToWebSocket(`/ws/${roomUuid}`);
    currentRoomUuid = roomUuid;
    socket.onopen = () => {
      try {
        socket.send(JSON.stringify({ 
        type: "join_room", 
        room_uuid: currentRoomUuid 
        }));
      } catch (e) {
        console.error("Error opening room:", e);
        return false;
      }
    }
    // coté animation door
    const doorWrapper = document.getElementById("sas_door");

    if (!doorWrapper) return;
    if (doorWrapper.classList.contains("opening")) return;

    doorWrapper.classList.add("opening");

    doorWrapper.addEventListener("animationend", () => {
      if (doorWrapper && doorWrapper.parentNode) {
        doorWrapper.parentNode.removeChild(doorWrapper);
      }
    }, { once: true });
    //fin animation et suppression de la div
  }

  // EN Travaux --> pour ajouter de/des membres à ta room
  async function addMembers(){
    console.log("Ajouter des membres pour room:", currentRoomUuid);

    const input = document.querySelector('[name="new_inv"]');
    const rawInput = input.value;
    input.value = ''; // vider l'input dès qu'on entre dans la fonction

    const invitees = rawInput
      .split(',')
      .map(x => x.trim())
      .filter(Boolean);

    console.log("Liste invitée brute:", invitees);

    if (invitees.length === 0) {
      console.warn("Aucun membre à ajouter.");
      return;
    }

    // Vérifier que tous les éléments correspondent à un pseudo ou un uuid
    const validInvitees = invitees.filter(inv =>
      liste_utilisateurs.some(user =>
        user.uuid === inv || user.pseudo === inv
      )
    );

    if (validInvitees.length !== invitees.length) {
      console.error("Certains membres ne sont pas valides.");
      return;
    }

    await connectToWebSocket(`/ws/${currentRoomUuid}`);

    socket.onopen = () => {
      try {
        socket.send(JSON.stringify({
          type: "add_members",
          room_uuid: currentRoomUuid,
          invitees: validInvitees,
        }));
      } catch (e) {
        console.error("Error opening room:", e);
      }
    };
  }
  
  async function editRoomName(){
    console.log("Modifier le nom de ma room:", currentRoomUuid);

    await connectToWebSocket(`/ws/${currentRoomUuid}`);
    const input = document.querySelector('[name="change_Rname"]');
    const newName = input.value.trim();

    // Conditions de validation
    const isSameName = newName === glob_room_name;
    const isTooShort = newName.length < 4;
    const isEmpty = newName === "";
    const hasDangerousChars = /['"\\;%]/.test(newName); // ajoute ou modifie ce regex selon ton niveau de sécurité

    if (isSameName || isTooShort || isEmpty || hasDangerousChars) {
      console.warn("Nom invalide ou inchangé, aucune requête envoyée.");
      return;
    }

    socket.onopen = () => {
      try {
        socket.send(JSON.stringify({ 
          type: "change_room_name", 
          room_uuid: currentRoomUuid,
          content: newName
        }));
      } catch (e) {
        console.error("Erreur lors de l'envoi du nom de room :", e);
      }
    };
  }

  // Permet de supprimer un membre dans une room a tester
  async function deleteMember(member_uuid){
    console.log("member_uuid ultime: ", member_uuid);
    console.log("uuid room: ", currentRoomUuid);

    console.log("verification des informations: membre ciblé:", member_uuid, "membre actuel:", current_user_uuid)
    if (member_uuid != current_user_uuid){
      console.log("j'entre ici")
      await connectToWebSocket(`/ws/${currentRoomUuid}`);
      
      socket.onopen = () => {
        try {
          socket.send(JSON.stringify({ 
          type: "delete_member", 
          room_uuid: currentRoomUuid,
          member_uuid: member_uuid,
          }));
        } catch (e) {
          console.error("Error opening room:", e);
          return false;
        }
      }
    }

  }

  // Quand on ajoute un membre à la room, function qui ajoute à la liste le membre, FRONT fetch FCT
  async function fetchMember(parsed) {
    const members = parsed.json?.members || [];
    console.log("members ajoutés: ", members);

    const list_coll = document.getElementById("roomColleagues");
    list_coll.textContent = "";

    members.forEach(member => {
        const uuid = member.uuid;
        const pseudo = member.pseudo;
        const owner = member.owner;

        // Crée un <li> pour le collègue
        const collegue = document.createElement("li");
        collegue.className = "liste_collegue";

        // Crée le lien vers le profile
        const lienCol = document.createElement("a");
        lienCol.id = uuid;
        lienCol.textContent = pseudo;
        lienCol.target = "_blank";
        lienCol.href = `/profile/${uuid}`;

        if (owner){
          pngCol = document.createElement("div");
          pngCol.className = "CalliberPng";
          pngCol.innerHTML = '<img src="/static/ressources/icons/crown.png" style="width: 100%;"/>';
        }

        // Div pour bouton de suppression (SVG)
        const svgCol = document.createElement("div");
        svgCol.className = "redCalliberSvg";
        svgCol.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                    <path stroke-dasharray="64" stroke-dashoffset="64" d="M12 3c4.97 0 9 4.03 9 9c0 4.97 -4.03 9 -9 9c-4.97 0 -9 -4.03 -9 -9c0 -4.97 4.03 -9 9 -9Z">
                        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.6s" values="64;0"/>
                    </path>
                    <path stroke-dasharray="8" stroke-dashoffset="8" d="M12 12l4 4M12 12l-4 -4M12 12l-4 4M12 12l4 -4">
                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="8;0"/>
                    </path>
                </g>
            </svg>`;
        svgCol.addEventListener('click', () => {
          if (confirm("Supprimer ce membre ?")) {
            deleteMember(member.uuid);
          }
        });

        // Ajout au DOM
        collegue.appendChild(lienCol);
        if (owner){
          collegue.appendChild(pngCol);
        }
        collegue.appendChild(svgCol);
        list_coll.appendChild(collegue);
    });
  }


  async function settings(){
    console.log("setting", currentRoomUuid);
    document.getElementById("roomModal").style.display = "block";
  }
  function closeRoomModal() {
    document.getElementById("roomModal").style.display = "none";
  }

  // function inutilisée pour récupérer la liste des utilisateurs
  async function fetch_users() {  
    console.log("Loading users:");
    await connectToWebSocket();
    
    socket.onopen = () => {
      try {
        socket.send(JSON.stringify({ 
        type: "fetch_users", 
        // room_uuid: currentRoomUuid 
        }));
      } catch (e) {
        console.error("Error opening room:", e);
        return false;
      }
    }
  }

  // Sert pas, exemple sample only --- Safe send function to handle connection state
  function safeSend(message) {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      console.error("Cannot send message, socket is not open");
      return false;
    }
    
    try {
      if (typeof message === 'object') {
        socket.send(JSON.stringify(message));
      } else {
        socket.send(message);
      }
      return true;
    } catch (e) {
      console.error("Error sending message:", e);
      return false;
    }
  }


  // === Gestion des rooms ===
  //permet d'avoir un visualisation directe de la room créée
  function roomsContainer_filler(room){
    // pub name: String,
    // pub room_uuid: String,
    // pub member_count
    console.log("room disponible à ajouter: ", room);

    const roomsContainer = document.getElementById("rooms_container");
    const roomCards = roomsContainer.querySelectorAll('.room_card');

    if (roomCards.length === 0) {
      roomsContainer.innerHTML = ''; // ou container.remove(); si tu veux carrément supprimer le div
    }

    let divP = document.createElement("div");
    divP.className = "room_card";
    divP.onclick = () => openRoom(room.room_uuid);

    let titleP = document.createElement("h3");
    titleP.textContent = room.name;

    let pP = document.createElement("p");
    let strongP = document.createElement("strong");
    strongP.textContent = "Membres : " + room.member_count;

    pP.appendChild(strongP);
    divP.appendChild(titleP);
    divP.appendChild(pP);
    // roomsContainer.appendChild(divP);
    roomsContainer.insertBefore(divP, roomsContainer.firstChild);

      // <div class="room_card" onclick="openRoom('room.room_uuid')">
      // <h3>room.name</h3>
      // <p><strong>Membres :</strong>room.member_count</p>
      // </div>
  }
  
  // === Gestion des messages websocket ===
  async function handleIncomingMessage(data) {
    // console.log("j'entre ici dans handleIncomingMessage")
    let parsed;
    try {
      parsed = JSON.parse(data);
      // console.log("parsed data:", parsed);
    } catch (e) {
      console.error("Erreur JSON handleIncomingMessage", e);
      return;
    }

    switch (parsed.type) {
      case 'direct_message':
        console.log(`Message privé de ${parsed.user_uuid}: ${parsed.message}`);
        // Afficher la notification de message privé
        displayPrivateMessage(parsed);
        break;
      case "room_created":
        // console.log("room_created fetch puis display")
        const res = await fetch(`/api/notifications/${parsed.user_uuid}`);
        const notifications = await res.json();
        // console.log("notifications", notifications)
        
        displayNotifications(notifications);

        // ajouter la room à la liste des rooms disponibles
        // /api/room/{user_uuid}
        const resRooms = await fetch(`/api/room/${parsed.room_uuid}`);
        const list_R = await resRooms.json();
        roomsContainer_filler(list_R);
        break;
      case "room_with_messages":
        // console.log("Room info:", parsed);
        // message: "", name: "Kende", room_uuid: "74f4820a-c4bc-4e85-930b-dc18c98d6d60"
        // écrit toutes les informations de la room
        displayRoomMessages(parsed);
        // rempli les information pour la modal settings
        displayRoomSettings(parsed);
        currentRoomUuid = parsed.room_uuid;
        break;
      case "list_users":
        console.log("voici tous les utilisateurs!:\n\t", parsed.json);
        // console.log("\nvoici tous les utilisateurs!:", parsed);
        // displayTempListUser(parsed.json);
        liste_utilisateurs = [];
        parsed.json.forEach(element => {
                liste_utilisateurs.push({ pseudo: element.pseudo, uuid: element.uuid });
        });
        break;
      case "new_message":
        // messages_json: []
        // Message envoyé au client: 
        // {"msg":"Room et messages récupérés.","type":"room_with_messages","message":"",
        // "name":"hggg","room_uuid":"01ea9560-49cf-4e57-b485-4e29ca6081b8","user_uuid":null}
          // const msg = data.message; // Contient un seul message ici
          const msg = parsed;
          displayIncomingMessage(msg);
        break;
      case "add_members_clear":
        displayAllNotifs();
        console.log("ajout du/des membres avec succes!")
        fetchMember(parsed);
        break;
      case "suppr_members_clear":
        displayAllNotifs();
        console.log("membres supprimés avec succes!")
        fetchMember(parsed);
        break;
      case "name_change_clear":
        console.log("name_change_clear", parsed.name);
        document.getElementById("room_name").textContent = parsed.name
        glob_room_name = parsed.name;
        break;
      case 'direct_message_sent':
        console.log(`Message bien envoyé à ${parsed.user_uuid}`);
        break;
      case 'direct_message_failed':
        console.log(`Échec d'envoi du message à ${parsed.user_uuid}: ${parsed.message}`);
        break;
      case "error":
        console.error("Erreur : " + parsed.message);
        break;
      default:
        console.log('Message reçu:', parsed);
        break;
    }
  }

  function sendMessage() {
    const input = document.getElementById("message_input");
    const msg = input.value.trim();

    try {
      if (msg && socket && socket.readyState === WebSocket.OPEN) {
      socket.send(JSON.stringify({
        type: "chat",
        room_uuid: currentRoomUuid,
        message: msg
        }));
        input.value = "";
      }
    } catch (e) {
      console.error("Error sending message chat:", e);
      return false;
    }
    // if (msg && socket && socket.readyState === WebSocket.OPEN) {
    //   socket.send(JSON.stringify({
    //     type: "chat",
    //     room_uuid: currentRoomUuid,
    //     message: msg
    //   }));
    //   input.value = "";
    // }
    // faire en sorte que la sall uuid soit deja enregisté en backend pour ne pas avoir à l'envoyer
    
  }
  
  // Fonction pour envoyer un message privé PAS ENCORE IMPLEMENTER
  function sendDirectMessage(targetUserUuid, message) {
    const messageData = {
      type: 'direct_message',
      target_user: targetUserUuid,
      message: message
    };
    
    ws.send(JSON.stringify(messageData));
  }
  //systeme d'affichage temporaire
  function displayTempListUser(json){
    const list_user = document.getElementById('list_user');
    const datalist = document.getElementById('user_list');

    datalist.innerHTML = ""; // Clear datalist options
    list_user.innerHTML = ""; // Clear previous displayed user cards
    liste_utilisateurs = [];

    console.log("json", json, json.length)
    if (json.length === 0) {
        list_user.style.display = 'none';
        return;
    }

    list_user.style.display = 'block';

    json.forEach(element => {
        liste_utilisateurs.push({ pseudo: element.pseudo, uuid: element.uuid });

        let option = document.createElement("option");
        option.value = element.pseudo;
        datalist.appendChild(option);

        let btnDispatch = document.createElement("button");
        if (element.status === "following") {
          btnDispatch.textContent = "Déjà suivi";
          btnDispatch.disabled = true;
          btnDispatch.classList.add("btn_following");
        } else if (element.status === "pending") {
          btnDispatch.textContent = "Demande en cours";
          btnDispatch.disabled = true;
          btnDispatch.classList.add("btn_pending");
        } else {
          // Status = not_following
          btnDispatch.textContent = "Suivre";
          btnDispatch.onclick = () => askFriend(element.uuid);
          btnDispatch.classList.add("btn_follow");
        }
        


        let divDispatch = document.createElement("div");
        divDispatch.className = "card_users";
        divDispatch.id = element.uuid;

        let aDispatch = document.createElement("a");
        aDispatch.textContent = element.pseudo;
        aDispatch.href = "/profile/" + element.uuid;
        aDispatch.target = "_blank";

        divDispatch.appendChild(aDispatch);
        divDispatch.appendChild(btnDispatch);
        list_user.appendChild(divDispatch);
    });
  }

  // effectue un enregistrement dans la table Demande_amis et dans notification pour informer le principal interessé
  function askFriend(receiverUuid) {
    if (!socket || socket.readyState !== WebSocket.OPEN) {
      console.error("WebSocket is not open.");
      return;
    }
    console.log("uuid", receiverUuid)
    // faire le fetch dans le back pour faire la demande d'amis 
    // suivre ? -> verification si tu l'as deja follow par un unfollow
    // dans la liste d'amis (function pas encore faite) faire un bouton unfollow egalement

    try {
      const msg = {
        type: "ask_friend",
        receiver_uuid: receiverUuid,
      };

      socket.send(JSON.stringify(msg));
      console.log("Sent ask_friend message to:", receiverUuid);
    } catch (e) {
      console.error("Error sending ask_friend message:", e);
    }
    // 🔁 Récupérer la valeur actuelle de l’input de recherche
    const searchInput = document.querySelector('.left_search input');
    const search = searchInput.value.trim();
  
    // 🔄 Refaire un fetch pour actualiser la liste des utilisateurs
    if (search.length > 0) {
      fetch(`/api/search_users?query=${encodeURIComponent(search)}`)
        .then(res => res.json())
        .then(json => displayTempListUser(json))
        .catch(err => console.error("Error fetching updated user list:", err));
    }
  }


  //reception de tous les messages entrant pour une room
  function displayRoomMessages(messages) {
    // id: 3
    // room_uuid: "471b09c9-619f-49f8-ae29-eac44431f1d8"
    // user_name: "jeremy"
    // user_uuid: "94015cd7-374e-4247-9c25-0f3cb86ae049"
    // content: "ultimatata"
    // created_at: "24/04/2025 08:37:19"
    console.log("=====> messages: \n", messages);

    const name_room = document.getElementById("room_name");
    let message_content = document.getElementById("message_content");
    

    name_room.textContent = messages.name;
    glob_room_name = messages.name; // variable globale
    message_content.innerHTML = "";

    let lastDate = "";

    messages.json.messages.forEach(msg => {
        const [day, month, yearWithTime] = msg.created_at.split("/");
        const [year, time] = yearWithTime.split(" ");
        const currentDate = `${day}/${month}/${year}`;
        const currentTime = time;

        // ➤ Si on a changé de jour : ajoute une séparation de date
        if (currentDate !== lastDate) {
            const dateSeparator = document.createElement("div");
            dateSeparator.textContent = currentDate;
            dateSeparator.classList.add("date-separator");
            message_content.appendChild(dateSeparator);
            lastDate = currentDate;
        }

        // ➤ Création de la div message
        const msgDiv = document.createElement("div");
        msgDiv.classList.add("message-block");
        if (msg.user_uuid === current_user_uuid) {
          msgDiv.classList.add("sent_by_me");
        } else {
          msgDiv.classList.add("received");
        }

        // User name
        const nameDiv = document.createElement("div");
        nameDiv.textContent = msg.user_name;
        nameDiv.classList.add("user-name");

        // Content
        const contentDiv = document.createElement("div");
        contentDiv.textContent = msg.content;
        contentDiv.classList.add("message-content");

        // Timestamp (heure)
        const timeDiv = document.createElement("div");
        timeDiv.textContent = currentTime;
        timeDiv.classList.add("message-time");

        // Ajoute les sous-divs au bloc principal
        msgDiv.appendChild(nameDiv);
        msgDiv.appendChild(contentDiv);
        msgDiv.appendChild(timeDiv);

        // Ajoute au contenu principal
        message_content.appendChild(msgDiv);
    });
  }
  
  function displayRoomSettings(messages){
    let list_coll = document.getElementById("roomColleagues");
    list_coll.innerHTML = "";
    // new! ajout dans la modale du nom de la room pour son changement possible
    const change_name = document.getElementById("change_Rname")
    change_name.value = messages.name;

    messages.json.member_uuids.forEach(member => {
      // console.log("uuid member: ",member);
      let collegue = document.createElement("li");
      collegue.className="liste_collegue";
      let lienCol = document.createElement("a")
      lienCol.id = member.uuid;
      lienCol.textContent = member.pseudo;
      lienCol.href = "_blanc"; // à ajouter quand la MAJ sera la pour aller sur le profile du pseudo

      if (member.owner){
        pngCol = document.createElement("div");
        pngCol.className = "CalliberPng";
        pngCol.innerHTML = '<img src="/static/ressources/icons/crown.png" style="width: 100%;"/>';
      }

      svgCol = document.createElement("div");
      svgCol.className = "redCalliberSvg";
      svgCol.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24">
                <g fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2">
                    <path stroke-dasharray="64" stroke-dashoffset="64" d="M12 3c4.97 0 9 4.03 9 9c0 4.97 -4.03 9 -9 9c-4.97 0 -9 -4.03 -9 -9c0 -4.97 4.03 -9 9 -9Z">
                        <animate fill="freeze" attributeName="stroke-dashoffset" dur="0.6s" values="64;0"/>
                    </path>
                    <path stroke-dasharray="8" stroke-dashoffset="8" d="M12 12l4 4M12 12l-4 -4M12 12l-4 4M12 12l4 -4">
                        <animate fill="freeze" attributeName="stroke-dashoffset" begin="0.6s" dur="0.2s" values="8;0"/>
                    </path>
                </g>
            </svg>`;
      svgCol.addEventListener('click', () => {
        if (confirm("Supprimer ce membre ?")) {
          deleteMember(member.uuid);
        }
      });
      collegue.appendChild(lienCol);

      if (member.owner){
        collegue.appendChild(pngCol);
      }

      collegue.appendChild(svgCol);
      
      list_coll.appendChild(collegue);

    })
  }
  // reception d'un message entrant provenant d'une personne inscrite dans la room
  function displayIncomingMessage(msg) {
    console.log("==> display_IncomingMessage!", msg)
    // msg: "Nouveau message",
    // type: "new_message",
    // message: "reseteur je t'aime épouse moi !",
    // name: "Anonymous",
    // room_uuid: "471b09c9-619f-49f8-ae29-eac44431f1d8",
    // user_uuid: "94015cd7-374e-4247-9c25-0f3cb86ae049",
    // json: {
    //   content: "reseteur je t'aime épouse moi !",
    //   created_at: "25/04/2025 10:40:28",
    //   user_name: "Anonymous",
    //   user_uuid: "94015cd7-374e-4247-9c25-0f3cb86ae049"
    // }
    const message_content = document.getElementById("message_content");

    const json = msg.json;

    // Vérifie que les champs existent
    if (!json || !json.created_at || !json.user_name || !json.content) {
        console.warn("⚠️ Données de message invalides :", json);
        return;
    }

    // Séparation par date (optionnelle ici)
    const [day, month, yearWithTime] = json.created_at.split("/");
    const [year, time] = yearWithTime.split(" ");
    const currentDate = `${day}/${month}/${year}`;
    const currentTime = time;

    // ➤ Création du message
    // Création du bloc message
    const msgDiv = document.createElement("div");
    msgDiv.classList.add("message-block");
    msgDiv.classList.add(msg.user_uuid === current_user_uuid ? "sent-by-me" : "received");

    // user_name
    const nameDiv = document.createElement("div");
    nameDiv.textContent = msg.json.user_name;
    nameDiv.classList.add("user-name");

    // content
    const contentDiv = document.createElement("div");
    contentDiv.textContent = msg.json.content;
    contentDiv.classList.add("message-content");

    // heure
    const timeDiv = document.createElement("div");
    timeDiv.textContent = currentTime;
    timeDiv.classList.add("message-time");

    // Append
    msgDiv.appendChild(nameDiv);
    msgDiv.appendChild(contentDiv);
    msgDiv.appendChild(timeDiv);
    message_content.appendChild(msgDiv);

    // Scroll auto vers le bas
    message_content.scrollTop = message_content.scrollHeight;
  }

  // === Notifications ===
  function toggleNotifications() {
    const notif = document.getElementById("notifications");
    notif.style.display = notif.style.display === "block" ? "none" : "block";
  }

  function displayNotifications(notifications) {
    const container = document.getElementById("notifications-list");
    container.innerHTML = "";

    notifications.forEach((notif) => {
      const li = document.createElement("li");
      li.innerHTML = `
        <button class="delNotif" id="${notif.id}" onclick="deleteNotification(${notif.id})" style="margin-left:10px">❌</button>
        ${notif.message}
      `;
      container.appendChild(li);
    });
  }
  
  async function deleteNotification(id) {
    // console.log("Deleting notification with id:", id); // Vérifie l'ID
    await fetch(`/api/notificationsD/${id}`, {
      method: "DELETE",
    });

    // Re-fetch après suppression
    displayAllNotifs()
  }
  
  // fonctionne bien appel une fonction dans handlers.rs -> get_user_notifications
  async function displayAllNotifs(){
    // let user_uuid = document.getElementById("uuid").value;
    // console.log("get_user_notifications, nouveaux notifs + uuid", user_uuid)
    const resu = await fetch(`/api/notif/${current_user_uuid}`);
      const notifications = await resu.json();
      // console.log("notifs: \n",notifications)
      displayNotifications(notifications);
  }
  // === Rooms ===
  function displayRooms(rooms){
    // <aside class="list_room">
    // <h2>Rooms disponibles :</h2>
    // <div class="rooms_container" id="rooms_container">
    let container_room = document.getElementById("rooms_container");
    container_room.textContent = "";

    rooms.forEach((room) => {
      let div_room = document.createElement("div")
      div_room.className = "room_card";
      // <div class="room_card" onclick="openRoom('room.room_uuid')">
      div_room.onclick = () => openRoom(room.uuid);
      // <h3>room.name</h3>
      let h3_room = document.createElement("h3");
      h3_room.textContent = room.name;

      div_room.appendChild(h3_room)

      // ajout des membres
      // <p><strong>Membres:</strong> room.member_count</p>
      let p_room = document.createElement("p");
      let strong_room = document.createElement("strong");
      strong_room.textContent = "Membres: ";

      p_room.appendChild(strong_room);

      room.content.forEach((member) => {
        let span = document.createElement("span");
        span.textContent = member + " ";
        p_room.appendChild(span);
      });

      div_room.appendChild(p_room);
      container_room.appendChild(div_room);

      
    });
  }
  // fonctionne bien appel une fonction dans handlers.rs -> get_user_notifications
  async function displayAllRooms(){
    // let user_uuid = document.getElementById("uuid").value;
    // console.log("get_user_notifications, nouveaux notifs + uuid", user_uuid)
    const resu = await fetch(`/api/rooms/${current_user_uuid}`);
      const rooms = await resu.json();
      console.log("rooms: \n",rooms)
      displayRooms(rooms);
  }
  async function displayAllFriendRequest(){
    const resu = await fetch(`/api/demand/${current_user_uuid}`);
      const requests = await resu.json();
      console.log("rooms ULTIMEFLASH: \n",requests)
      // displayResquest(requests);
  }

  // === Modale création room ===
  function setupRoomModal() {
    document.getElementById("open_room_modal").addEventListener("click", () => {
      document.getElementById("room-modal").style.display = "block";
    });

    document.getElementById("close-room-modal").addEventListener("click", () => {
      document.getElementById("room-modal").style.display = "none";
    });

    document.getElementById("create_room_form").addEventListener("submit", async (e) => {
      e.preventDefault();

      const name = e.target.room_name.value;
      const visibility = e.target.visibility.value;
      const invitees = e.target.invitees.value.split(',').map(x => x.trim()).filter(Boolean);
      try {
        socket.send(JSON.stringify({
        type: "create_room",
        name,
        visibility,
        invitees
        }));
      } catch (e) {
        console.error("Error sending message:", e);
        return false;
      }
      // socket.send(JSON.stringify({
      //   type: "create_room",
      //   name,
      //   visibility,
      //   invitees
      // }));

      document.getElementById("room-modal").style.display = "none";
      displayAllNotifs()
    });
  }

  // === Tabs UI ===
  function showTab(tabId) {
    document.getElementById("room_tab").style.display = tabId === "room_tab" ? "block" : "none";
    document.getElementById("search_tab").style.display = tabId === "search_tab" ? "block" : "none";

    document.getElementById("btn_room").classList.toggle("active-tab", tabId === "room_tab");
    document.getElementById("btn_search").classList.toggle("active-tab", tabId === "search_tab");
  }

  // === Init au chargement ===
  document.addEventListener("DOMContentLoaded", () => {
    
    let current_user_uuid = document.getElementById("uuid")?.value;
    // const uuidInput = document.getElementById("uuid");
    // if (uuidInput) {
    //     const current_user_uuid = uuidInput.value;
    //     console.log("value", current_user_uuid);

    //     // Supprimer l'input du DOM
    //     uuidInput.remove();
    // }

    // Make initial connection
    // connectToWebSocket();
    
    // Set up other functionality
    if (typeof setupRoomModal === 'function') setupRoomModal();
    if (typeof displayAllNotifs === 'function') displayAllNotifs();
    //debut pour travailler sur les utilisateurs EN TRAVAUX
    if (typeof fetch_users === 'function') fetch_users();
    if (typeof displayAllRooms === 'function') displayAllRooms();
    if (typeof displayAllFriendRequest === 'function') displayAllFriendRequest();

    // bloc de suggestion invité for room creation for smooth search
    // const input = document.getElementById('invitees_input');
    // const suggestionBox = document.getElementById('invitees_suggestions');
    // input.addEventListener('input', function () {
    //   const fullInput = this.value;
    //   const parts = fullInput.split(',');
    //   const currentQuery = parts[parts.length - 1].trim().toLowerCase();
    //   suggestionBox.innerHTML = '';
    //   if (currentQuery.length === 0) {
    //     suggestionBox.style.display = 'none';
    //     return;
    //   }
    //   // deuxieme secutrité user.uuid !== current_user_uuid
    //   const results = liste_utilisateurs.filter(user =>
    //     user.uuid !== current_user_uuid && (
    //       user.pseudo.toLowerCase().includes(currentQuery) ||
    //       user.uuid.toLowerCase().includes(currentQuery)
    //     )
    //   );
    //   if (results.length > 0) {
    //     results.forEach(user => {
    //       const li = document.createElement('li');
    //       li.textContent = `${user.pseudo} (${user.uuid})`;
    //       li.dataset.uuid = user.uuid;
    //       li.addEventListener('click', () => {
    //         // Remplace la dernière entrée par l'UUID sélectionné
    //         parts[parts.length - 1] = ` ${user.uuid}`;
    //         input.value = parts.map(p => p.trim()).join(', ') + ', ';
    //         suggestionBox.style.display = 'none';
    //         input.focus();
    //       });
    //       suggestionBox.appendChild(li);
    //     });
    //     suggestionBox.style.display = 'block';
    //   } else {
    //     suggestionBox.style.display = 'none';
    //   }
    // });
    function initInviteeSuggestions(inputId, suggestionBoxId) {
      const input = document.getElementById(inputId);
      const suggestionBox = document.getElementById(suggestionBoxId);

      input.addEventListener('input', function () {
        const fullInput = this.value;
        const parts = fullInput.split(',');
        const currentQuery = parts[parts.length - 1].trim().toLowerCase();

        suggestionBox.innerHTML = '';

        if (currentQuery.length === 0) {
          suggestionBox.style.display = 'none';
          return;
        }

        const results = liste_utilisateurs.filter(user =>
          user.uuid !== current_user_uuid && (
            user.pseudo.toLowerCase().includes(currentQuery) ||
            user.uuid.toLowerCase().includes(currentQuery)
          )
        );

        if (results.length > 0) {
          results.forEach(user => {
            const li = document.createElement('li');
            li.textContent = `${user.pseudo} (${user.uuid})`;
            li.dataset.uuid = user.uuid;

            li.addEventListener('click', () => {
              parts[parts.length - 1] = ` ${user.uuid}`;
              input.value = parts.map(p => p.trim()).join(', ') + ', ';
              suggestionBox.style.display = 'none';
              input.focus();
            });

            suggestionBox.appendChild(li);
          });

          suggestionBox.style.display = 'block';
        } else {
          suggestionBox.style.display = 'none';
        }
      });

      // décalé en dehors de l'event init pour éviter les problèmes de closure
      document.addEventListener('click', function (e) {
        const target = e.target;
        const clickedInsideInput = input.contains(target);
        const clickedInsideSuggestion = suggestionBox.contains(target);

        if (!clickedInsideInput && !clickedInsideSuggestion) {
          suggestionBox.style.display = 'none';
        }
      });
    }

    initInviteeSuggestions('invitees_input', 'invitees_suggestions');
    initInviteeSuggestions('new_inv', 'new_inv_suggestions');

    //animation pour un svg + raffraichissement des rooms pour anticiper une nouvelle arrivée 
    const icon = document.getElementById('rotate_icon');

    icon.addEventListener('click', () => {
      if (typeof displayAllRooms === 'function') displayAllRooms();
      // Applique la rotation animée à -180deg
      icon.style.transition = 'transform 0.3s';
      icon.style.transform = 'rotate(-360deg)';

      // Après 300ms (animation terminée), désactive transition, remet à 0 instantanément
      setTimeout(() => {
        icon.style.transition = 'none';
        icon.style.transform = 'rotate(0deg)';

        // Rétablit la transition pour les prochains clics
        setTimeout(() => {
          icon.style.transition = 'transform 0.3s';
        }, 20);
      }, 600);
    });
  //

    // search bar pour rechercher membres
    document.querySelector('.left_search input').addEventListener('input', function() {
      const search = this.value.trim();
      console.log("search: ", search);

      if (search.length > 0) {
        console.log("############################################đ€¶đ→ø€đ€¶")
        // fetch ton endpoint ici, par exemple :
        fetch(`/api/search_users?query=${encodeURIComponent(search)}`)
          .then(res => res.json())
          .then(json => displayTempListUser(json));
      } else {
        document.getElementById('list_user').style.display = 'none';
      }
    });
    // fin search bar pour rechercher membres

    
    // REDIRECTION PATH
    document.querySelectorAll(".redir").forEach(function (button) {
      button.addEventListener("click", function (event) {
        redirection(button);
      });
    });
    document.getElementById("message_input").addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
          const message = this.value.trim();
          const roomName = document.getElementById("room_name").textContent.trim();

          if (message !== "" && roomName !== "") {
              sendMessage();
          }
      }
    });
    
    function redirection(button, uuidDefault= current_user_uuid) {
      const id = button.id;
      switch (id) {
        case "profil_show":
          window.location.href = "/profile/"+current_user_uuid;
          break;
        case "profil_peek":
          window.location.href = "/profile/"+current_user_uuid;
          break;
        // Add other cases here
        default:
          console.log("No redirection defined for:", id);
      }
    }
  }); // fin de DOMContentLoaded
</script>